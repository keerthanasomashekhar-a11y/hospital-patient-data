<script>
let allPatients = []; // store all patients globally

// Load dashboard data
async function loadDashboard() {
    try {
        const res = await fetch("http://localhost:5001/api/patients"); // adjust if your backend route is different
        if (!res.ok) throw new Error("Failed to fetch patients");
        const data = await res.json();
        allPatients = data;

        // Total Count
        document.getElementById("totalPatients").textContent = data.length;

        // Last Added Patient
        if (data.length > 0) {
            const last = data[data.length - 1];
            document.getElementById("lastPatient").textContent =
                `${last.name}, Age: ${last.age}, Disease: ${last.disease}`;
        } else {
            document.getElementById("lastPatient").textContent = "None";
        }

        // Fill Disease Filter
        const diseases = [...new Set(data.map(p => p.disease))];
        const filterDropdown = document.getElementById("filterDisease");
        filterDropdown.innerHTML = `<option value="">Filter by Disease</option>`;
        diseases.forEach(d => {
            filterDropdown.innerHTML += `<option value="${d}">${d}</option>`;
        });

        // Render table
        renderTable(data);
    } catch (err) {
        console.error("Error loading dashboard:", err);
        alert("Failed to load patient data. Check backend connection.");
    }
}

// Render table function
function renderTable(data) {
    const table = document.getElementById("patientTable");
    table.innerHTML = "";

    if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="5" style="text-align:center;">No patients found</td></tr>`;
        return;
    }

    data.forEach(p => {
        const row = `
            <tr>
                <td>${p.name}</td>
                <td>${p.age}</td>
                <td>${p.disease}</td>
                <td><button class="btn update-btn" onclick="updatePatient('${p._id}')">Update</button></td>
                <td><button class="btn delete-btn" onclick="deletePatient('${p._id}')">Delete</button></td>
            </tr>
        `;
        table.innerHTML += row;
    });
}

// Search patients
function searchPatient() {
    const text = document.getElementById("searchBox").value.toLowerCase();
    const filtered = allPatients.filter(p =>
        p.name.toLowerCase().includes(text) ||
        p.disease.toLowerCase().includes(text) ||
        String(p.age).includes(text)
    );
    renderTable(filtered);
}

// Filter by disease
function filterDisease() {
    const disease = document.getElementById("filterDisease").value;
    if (disease === "") {
        renderTable(allPatients);
        return;
    }
    const filtered = allPatients.filter(p => p.disease === disease);
    renderTable(filtered);
}

// Delete patient
async function deletePatient(id) {
    if (!confirm("Are you sure you want to delete this patient?")) return;
    try {
        const res = await fetch(`http://localhost:5001/api/patients/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete patient");
        loadDashboard();
    } catch (err) {
        console.error("Delete error:", err);
        alert("Failed to delete patient.");
    }
}

// Update patient
async function updatePatient(id) {
    const patient = allPatients.find(p => p._id === id);
    if (!patient) return alert("Patient not found");

    const newName = prompt("Enter new name:", patient.name);
    if (newName === null) return; // cancel pressed
    const newAge = prompt("Enter new age:", patient.age);
    if (newAge === null) return;
    const newDisease = prompt("Enter new disease:", patient.disease);
    if (newDisease === null) return;

    try {
        const res = await fetch(`http://localhost:5001/api/patients/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: newName, age: newAge, disease: newDisease })
        });
        if (!res.ok) throw new Error("Failed to update patient");
        loadDashboard();
    } catch (err) {
        console.error("Update error:", err);
        alert("Failed to update patient.");
    }
}

// Initial load
loadDashboard();
</script>
